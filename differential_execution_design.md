# 差分実行機能の実装設計

## 概要

現在の全テーブル実行方式から、変更されたテーブルとその影響範囲のみを実行する差分実行機能を実装する。

## 実装スコープ

### 対象
- **設定ファイルの変更検出**: アダプター/モデルファイルの追加・削除・内容変更
- **依存関係変更の検出**: モデルのSQL文における依存テーブルの変更
- **影響範囲の分析**: 変更されたテーブルに依存する下流テーブルの特定

### 除外
- データソースファイルの変更（freshness）
- 時間ベースの更新判定（max_age）
- エラーハンドリングの詳細化
- パフォーマンス最適化

## 実装戦略（3段階）

### フェーズ1: 詳細な変更検出
**目標**: 何が変更されたかを具体的に特定できるようにする

**変更内容**:
- `src/metadata.rs`の`detect_changes`関数を拡張
- 新しい構造体`GraphChanges`の導入
- 変更されたノード・エッジの詳細を返す機能

**新しいデータ構造**:
```rust
pub struct GraphChanges {
    pub added_nodes: Vec<String>,           // 新規追加されたテーブル
    pub removed_nodes: Vec<String>,         // 削除されたテーブル
    pub added_edges: Vec<(String, String)>, // 新規依存関係
    pub removed_edges: Vec<(String, String)>, // 削除された依存関係
}
```

**新しい関数**:
```rust
pub async fn detect_changes(
    db: &DatabaseConnection, 
    current_graph: &Graph
) -> Result<Option<GraphChanges>>
```

### フェーズ2: 影響範囲分析
**目標**: 変更されたテーブルの下流テーブルを特定する

**実装内容**:
- グラフトラバーサル機能の実装
- 依存関係を辿って影響を受けるテーブルを収集
- 新しいモジュール`src/impact_analysis.rs`の作成

**新しい関数**:
```rust
pub fn calculate_affected_nodes(
    graph: &Graph, 
    changes: &GraphChanges
) -> Vec<String>
```

### フェーズ3: 部分パイプライン実行
**目標**: 影響を受けるテーブルのみでパイプラインを実行する

**変更内容**:
- `src/pipeline.rs`に部分実行機能を追加
- トポロジカルソートを影響ノードに限定
- `src/commands/run.rs`の実行ロジック更新

**新しい機能**:
```rust
impl Pipeline {
    pub fn create_partial_pipeline(
        graph: &Graph,
        affected_nodes: &[String]
    ) -> Self
}
```

## 実装の詳細

### 変更検出ロジック
1. **前回のグラフ取得**: データベースから最新のグラフ情報を取得
2. **ノード差分計算**: HashSetを使った集合演算で追加・削除を特定
3. **エッジ差分計算**: 依存関係の追加・削除を特定
4. **変更理由の分類**: 新規作成 vs 依存関係変更 vs 削除

### 影響範囲計算アルゴリズム
1. **深度優先探索（DFS）**: 変更されたノードから下流へトラバース
2. **影響ノードの収集**: 直接・間接的に影響を受けるテーブルを特定
3. **重複排除**: 同じテーブルが複数の経路で影響を受ける場合の処理

### 部分実行の最適化
1. **必要最小限の実行**: 影響を受けるノードのみを処理対象
2. **実行順序の維持**: トポロジカルソートによる依存関係の遵守
3. **既存機能との統合**: 現在の実行ロジックとの互換性維持

## データフロー

```
1. 設定ファイル読み込み
   ↓
2. 現在のグラフ生成
   ↓
3. 変更検出（GraphChanges取得）
   ↓
4. 影響範囲分析（affected_nodes算出）
   ↓
5. 部分パイプライン生成
   ↓
6. 部分実行
   ↓
7. 実行履歴保存
```

## 段階的実装とテスト

### フェーズ1のテスト
- ノード追加・削除の検出テスト
- エッジ追加・削除の検出テスト
- 複合変更（ノード＋エッジ）の検出テスト

### フェーズ2のテスト
- 単一ノード変更の影響範囲テスト
- 複数ノード変更の影響範囲テスト
- 依存関係の深いグラフでの影響範囲テスト

### フェーズ3のテスト
- 部分パイプラインの生成テスト
- 部分実行の動作テスト
- 全実行との結果整合性テスト

## 実装順序

1. **フェーズ1の実装とテスト** → 完了後フェーズ2へ
2. **フェーズ2の実装とテスト** → 完了後フェーズ3へ
3. **フェーズ3の実装とテスト** → 完了後統合テスト

各フェーズで動作確認とテストを実施し、問題があれば前のフェーズに戻って修正する。